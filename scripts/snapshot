#!/usr/bin/env bash
set -euo pipefail

# mrk snapshot — export current machine state back into the repo
#
# Exports managed app preferences (plists) to assets/preferences/ so
# they can be committed and replicated on a new machine via post-install.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
readonly SCRIPT_DIR REPO_ROOT

log()  { printf "[snapshot] %s\n" "$*"; }
warn() { printf "[snapshot] Warning: %s\n" "$*" >&2; }

OPT_BREWFILE=0

usage() {
  cat <<EOF
Usage: snapshot [--brewfile] [--help]

Export current machine preferences back into the mrk-dev repo.

Options:
  --brewfile    Also dump Homebrew Brewfile (off by default; destructive)
  --help        Show this help
EOF
}

for arg in "$@"; do
  case "$arg" in
    --brewfile) OPT_BREWFILE=1 ;;
    --help|-h)  usage; exit 0 ;;
    *) warn "Unknown argument: $arg"; usage >&2; exit 1 ;;
  esac
done

PREFS_DIR="$REPO_ROOT/assets/preferences"

###############################################################################
# Plist exports                                                               #
###############################################################################

# Export a managed plist from system preferences back to the repo asset.
# Converts to XML for readable git diffs.
# Skips gracefully if the app is not installed or has no prefs yet.
export_plist() {
  local app_path="$1" bundle_id="$2" dest_file="$3" name="$4"
  local existing="$HOME/Library/Preferences/${bundle_id}.plist"

  if [[ ! -d "$app_path" ]]; then
    log "Skipping $name (not installed)"
    return 0
  fi
  if [[ ! -f "$existing" ]]; then
    log "Skipping $name (no preferences found)"
    return 0
  fi
  defaults export "$bundle_id" "$dest_file"
  plutil -convert xml1 "$dest_file"
  log "Exported $name → $(basename "$dest_file")"
}

export_plist "/Applications/BetterSnapTool.app" "com.hegenberg.BetterSnapTool" \
  "$PREFS_DIR/BetterSnapTool.plist" "BetterSnapTool"

export_plist "/Applications/Ice.app" "com.jordanbaird.Ice" \
  "$PREFS_DIR/Ice.plist" "Ice"

export_plist "/Applications/iTerm.app" "com.googlecode.iterm2" \
  "$PREFS_DIR/iTerm2.plist" "iTerm2"

###############################################################################
# Brewfile (opt-in)                                                           #
###############################################################################

if (( OPT_BREWFILE )); then
  warn "Brewfile dump will OVERWRITE the existing Brewfile."
  warn "All manual sections, comments, and greedy: true annotations will be lost."
  if [[ -t 0 ]]; then
    printf "[snapshot] Proceed with Brewfile dump? [y/N]: "
    read -r answer </dev/tty
    if [[ "$answer" =~ ^[Yy]$ ]]; then
      if command -v brew >/dev/null 2>&1; then
        brew bundle dump --force --file="$REPO_ROOT/Brewfile"
        log "Brewfile updated"
      else
        warn "brew not found — skipping Brewfile"
      fi
    else
      log "Skipped Brewfile dump"
    fi
  else
    warn "Non-interactive mode: skipping Brewfile dump (requires confirmation)"
  fi
fi

###############################################################################
# Git status and optional commit                                              #
###############################################################################

cd "$REPO_ROOT"

check_paths=("assets/preferences/")
(( OPT_BREWFILE )) && check_paths+=("Brewfile")

if [[ -z "$(git status --porcelain -- "${check_paths[@]}" 2>/dev/null)" ]]; then
  log "No changes detected"
  exit 0
fi

log "Changes detected:"
git status --short -- "${check_paths[@]}" 2>/dev/null || true

if [[ -t 0 ]]; then
  printf "[snapshot] Commit changes? [y/N]: "
  read -r answer </dev/tty
  if [[ "$answer" =~ ^[Yy]$ ]]; then
    git add -- "${check_paths[@]}"
    git commit -m "snapshot: update managed preferences $(date +%Y-%m-%d)"
    log "Committed"
  else
    log "Skipped commit — run 'git add assets/preferences/ && git commit' when ready"
  fi
else
  log "Non-interactive mode — skipping commit. Run 'git diff assets/preferences/' to review."
fi
