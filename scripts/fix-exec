#!/usr/bin/env bash
# fix-exec â€” set executable bits on repo scripts and ~/bin (idempotent)

set -euo pipefail

# Resolve repo paths, following symlinks (works when called via ~/bin)
_self="${BASH_SOURCE[0]}"
while [[ -L "$_self" ]]; do
  _dir="$(cd "$(dirname "$_self")" && pwd)"
  _self="$(readlink "$_self")"
  [[ "$_self" != /* ]] && _self="$_dir/$_self"
done
BASE_DIR="$(cd "$(dirname "$_self")" && pwd)"
PROJECT_ROOT="$(dirname "$BASE_DIR")"

echo "ðŸ”§ Ensuring executable bits on mrk scriptsâ€¦"

# Fix repo scripts and bin directories directly
for dir in "$PROJECT_ROOT/scripts" "$PROJECT_ROOT/bin"; do
  if [ -d "$dir" ]; then
    find "$dir" -maxdepth 1 -type f -print0 2>/dev/null \
      | xargs -0 chmod +x 2>/dev/null || true
    echo "âœ“ Fixed executables in: $dir"
  fi
done

# In ~/bin, only fix symlinks that point back into this repo
if [ -d "$HOME/bin" ]; then
  fixed=0
  while IFS= read -r -d '' link; do
    target="$(readlink "$link" 2>/dev/null || true)"
    if [[ "$target" == "$PROJECT_ROOT"/* ]]; then
      chmod +x "$link" 2>/dev/null || true
      ((fixed++)) || true
    fi
  done < <(find "$HOME/bin" -maxdepth 1 -type l -print0 2>/dev/null || true)
  echo "âœ“ Fixed $fixed mrk symlink(s) in: $HOME/bin"
fi

echo "âœ… Done."
