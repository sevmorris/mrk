#!/usr/bin/env bash
set -euo pipefail

# mrk uninstaller - conservative
# - Unlinks ~/bin symlinks pointing into this repo
# - Optionally runs ~/.mrk/defaults-rollback.sh and hardening-rollback.sh
# - Does not remove user data or dotfiles

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
INSTALL_BIN="$HOME/bin"

log(){ printf "[uninstall] %s\n" "$*"; }
warn(){ printf "[warn] %s\n" "$*"; }

log "Unlinking mrk symlinks from $INSTALL_BIN..."
removed=0
failed=0

# Function to remove symlinks from a directory
remove_symlinks_from() {
  local dir="$1"
  if [[ ! -d "$dir" ]]; then
    return 0
  fi
  
  while IFS= read -r -d '' link; do
    local target
    target="$(readlink "$link" 2>/dev/null || true)"
    if [[ -z "$target" ]]; then
      continue
    fi
    
    # Check if symlink points to this repo's scripts or bin directories
    case "$target" in
      *"/scripts/"*|*"/bin/"*)
        # Verify it's actually in our repo
        if [[ "$target" == "$REPO_ROOT"/* ]]; then
          if rm -f "$link"; then
            log "Removed: $link -> $target"
            ((removed++)) || true
          else
            warn "Failed to remove: $link"
            ((failed++)) || true
          fi
        fi
        ;;
    esac
  done < <(find "$dir" -maxdepth 1 -type l -print0 2>/dev/null || true)
}

# Remove from current location (~/bin)
remove_symlinks_from "$INSTALL_BIN"

# Also clean up old ~/.local/bin links from previous installations
LEGACY_BIN="$HOME/.local/bin"
if [[ -d "$LEGACY_BIN" ]]; then
  log "Cleaning up old symlinks from $LEGACY_BIN..."
  remove_symlinks_from "$LEGACY_BIN"
fi

if (( removed > 0 )); then
  log "Removed $removed symlink(s)"
fi

if (( failed > 0 )); then
  warn "$failed symlink(s) failed to remove"
fi

if (( removed == 0 && failed == 0 )); then
  if [[ ! -d "$INSTALL_BIN" ]] && [[ ! -d "$LEGACY_BIN" ]]; then
    warn "Neither $INSTALL_BIN nor $LEGACY_BIN found (nothing to unlink)"
  fi
fi

offer_rollback() {
  local script="$1" label="$2"
  if [[ ! -x "$script" ]] || [[ ! -s "$script" ]]; then
    return 0
  fi
  if [[ -t 0 ]]; then
    read -r -p "Run $label rollback now? [y/N] " ans
    if [[ "$ans" =~ ^[Yy]$ ]]; then
      log "Running $script..."
      if "$script"; then
        log "$label rollback completed successfully"
      else
        warn "$label rollback returned non-zero exit code"
      fi
    else
      log "Skipped $label rollback (you can run it later: $script)."
    fi
  else
    log "Non-interactive mode: skipping $label rollback"
    log "You can run it manually: $script"
  fi
}

offer_rollback "$HOME/.mrk/defaults-rollback.sh" "macOS defaults"
offer_rollback "$HOME/.mrk/hardening-rollback.sh" "security hardening"

log "Uninstall complete."
