#!/usr/bin/env bash
set -euo pipefail

# mrk status — unified installation status

# Resolve symlinks so this works when called via ~/bin
_self="${BASH_SOURCE[0]}"
while [[ -L "$_self" ]]; do
  _dir="$(cd "$(dirname "$_self")" && pwd)"
  _self="$(readlink "$_self")"
  [[ "$_self" != /* ]] && _self="$_dir/$_self"
done
SCRIPT_DIR="$(cd "$(dirname "$_self")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
INSTALL_BIN="$HOME/bin"
STATE_DIR="$HOME/.mrk"
BREWFILE="$REPO_ROOT/Brewfile"

ok()    { printf '\033[32m✓ %s\033[0m\n' "$*"; }
warn()  { printf '\033[33m⚠ %s\033[0m\n' "$*"; }
err()   { printf '\033[31m✗ %s\033[0m\n' "$*"; }
info()  { printf '  %s\n' "$*"; }

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "  mrk Installation Status"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

###############################################################################
# Dotfiles                                                                    #
###############################################################################

echo "Dotfiles:"
if [[ -d "$REPO_ROOT/dotfiles" ]]; then
  linked=0
  missing=0
  shopt -s dotglob nullglob
  for src in "$REPO_ROOT/dotfiles"/*; do
    [[ -e "$src" ]] || continue
    # Skip .example files and README/documentation files (matching setup behavior)
    case "$(basename "$src")" in
      *.example|README*|*.md) continue ;;
    esac
    dst="$HOME/$(basename "$src")"
    if [[ -L "$dst" ]] && [[ "$(readlink "$dst")" == "$src" ]]; then
      ((linked++)) || true
    else
      ((missing++)) || true
      if [[ -e "$dst" ]]; then
        warn "  Not linked: $dst (file exists)"
      else
        info "  Not linked: $dst"
      fi
    fi
  done
  shopt -u dotglob nullglob
  
  if (( linked > 0 )); then
    ok "  $linked dotfile(s) linked"
  fi
  if (( missing == 0 && linked > 0 )); then
    ok "  All dotfiles linked"
  fi
else
  warn "  dotfiles directory not found"
fi
echo ""

###############################################################################
# Tools                                                                       #
###############################################################################

echo "Tools:"
if [[ -d "$INSTALL_BIN" ]]; then
  linked=0
  broken=0
  while IFS= read -r -d '' link; do
    target="$(readlink "$link" 2>/dev/null || true)"
    if [[ -n "$target" ]] && [[ "$target" == "$REPO_ROOT"/* ]]; then
      if [[ -e "$target" ]]; then
        ((linked++)) || true
      else
        ((broken++)) || true
        warn "  Broken link: $link -> $target"
      fi
    fi
  done < <(find "$INSTALL_BIN" -maxdepth 1 -type l -print0 2>/dev/null || true)
  
  if (( linked > 0 )); then
    ok "  $linked tool(s) linked"
  fi
  if (( broken > 0 )); then
    err "  $broken broken symlink(s)"
  fi
  if (( linked == 0 && broken == 0 )); then
    info "  No mrk tools linked"
  fi
else
  warn "  $INSTALL_BIN not found"
fi
echo ""

###############################################################################
# macOS Defaults                                                              #
###############################################################################

echo "macOS Defaults:"
if [[ -f "$STATE_DIR/defaults-rollback.sh" ]] && [[ -s "$STATE_DIR/defaults-rollback.sh" ]]; then
  rollback_lines=$(grep -c "defaults write\|defaults delete" "$STATE_DIR/defaults-rollback.sh" 2>/dev/null || echo "0")
  if (( rollback_lines > 0 )); then
    ok "  Defaults have been applied"
    info "  Rollback script: $STATE_DIR/defaults-rollback.sh"
    info "  ($rollback_lines change(s) can be rolled back)"
  else
    info "  No defaults applied"
  fi
else
  info "  No defaults applied"
fi
echo ""

###############################################################################
# Backups                                                                     #
###############################################################################

echo "Security Hardening:"
if [[ -f "$STATE_DIR/hardening-rollback.sh" ]] && [[ -s "$STATE_DIR/hardening-rollback.sh" ]]; then
  rollback_lines=$(grep -c "sudo\|defaults write\|defaults delete" "$STATE_DIR/hardening-rollback.sh" 2>/dev/null || echo "0")
  if (( rollback_lines > 0 )); then
    ok "  Hardening has been applied"
    info "  Rollback script: $STATE_DIR/hardening-rollback.sh"
    info "  ($rollback_lines change(s) can be rolled back)"
  else
    info "  No hardening applied"
  fi
else
  info "  No hardening applied"
fi
echo ""

echo "Backups:"
if [[ -d "$STATE_DIR/backups" ]]; then
  backup_count=$(find "$STATE_DIR/backups" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l | tr -d ' ')
  if (( backup_count > 0 )); then
    ok "  $backup_count backup(s) found"
    info "  Location: $STATE_DIR/backups"
    # Show most recent
    latest=$(find "$STATE_DIR/backups" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | sort -r | head -n1)
    if [[ -n "$latest" ]]; then
      info "  Latest: $(basename "$latest")"
    fi
  else
    info "  No backups found"
  fi
else
  info "  No backups directory"
fi
echo ""

###############################################################################
# Shell                                                                       #
###############################################################################

echo "Shell:"
if command -v zsh >/dev/null 2>&1; then
  current_shell="$(dscl . -read "/Users/$USER" UserShell 2>/dev/null | awk '{print $2}')" || current_shell="unknown"
  zsh_path="$(command -v zsh)"
  if [[ "$current_shell" == "$zsh_path" ]]; then
    ok "  Login shell: $current_shell"
  else
    warn "  Login shell: $current_shell (expected: $zsh_path)"
  fi
else
  warn "  zsh not found"
fi
echo ""

###############################################################################
# PATH                                                                        #
###############################################################################

echo "PATH:"
case ":$PATH:" in
  *":$INSTALL_BIN:"*)
    ok "  $INSTALL_BIN is on PATH"
    ;;
  *)
    warn "  $INSTALL_BIN is NOT on PATH"
    info "  Run: ./scripts/doctor --fix"
    ;;
esac
echo ""

###############################################################################
# Homebrew                                                                    #
###############################################################################

echo "Homebrew:"
if command -v brew >/dev/null 2>&1; then
  ok "  $(brew --version | head -n1)"
else
  err "  Not installed"
fi
echo ""

###############################################################################
# Brewfile packages                                                           #
###############################################################################

if [[ -f "$BREWFILE" ]]; then
  echo "Brewfile:"
  # Count items in single pass
  formulae=0; casks=0; taps=0
  while IFS= read -r line; do
    case "$line" in
      brew\ *) ((formulae++)) ;;
      cask\ *) ((casks++)) ;;
      tap\ *)  ((taps++)) ;;
    esac
  done < "$BREWFILE"
  ok "  Found ($formulae formulae, $casks casks, $taps taps)"

  if command -v brew >/dev/null 2>&1; then
    echo ""
    echo "Installed packages from Brewfile:"

    # Pre-fetch installed package lists for O(1) lookup
    declare -A _installed_formulae=()
    declare -A _installed_casks=()
    while IFS= read -r _pkg; do
      [[ -n "$_pkg" ]] && _installed_formulae["$_pkg"]=1
    done < <(brew list --formula 2>/dev/null)
    while IFS= read -r _pkg; do
      [[ -n "$_pkg" ]] && _installed_casks["$_pkg"]=1
    done < <(brew list --cask 2>/dev/null)

    installed=0; missing=0; total=0

    while IFS= read -r line; do
      [[ -z "$line" || "$line" =~ ^# ]] && continue

      if [[ "$line" =~ ^brew\ \"([^\"]+)\" ]]; then
        pkg="${BASH_REMATCH[1]}"
        ((total++))
        if [[ -n "${_installed_formulae[$pkg]+x}" ]]; then
          echo "  ✓ $pkg"
          ((installed++))
        else
          echo "  ✗ $pkg (not installed)"
          ((missing++))
        fi
      elif [[ "$line" =~ ^cask\ \"([^\"]+)\" ]]; then
        cask="${BASH_REMATCH[1]}"
        ((total++))
        if [[ -n "${_installed_casks[$cask]+x}" ]]; then
          echo "  ✓ $cask (cask)"
          ((installed++))
        else
          echo "  ✗ $cask (cask, not installed)"
          ((missing++))
        fi
      fi
    done < "$BREWFILE"

    echo ""
    echo "  Summary: $installed/$total installed, $missing missing"
  fi
  echo ""
fi

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
