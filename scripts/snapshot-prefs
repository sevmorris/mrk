#!/usr/bin/env bash
set -euo pipefail

# mrk snapshot-prefs — export current app preferences to ~/.mrk/preferences/
# and push to the private mrk-prefs repo.

PREFS_REPO="git@github.com:sevmorris/mrk-prefs.git"
LOCAL_PREFS_DIR="$HOME/.mrk/preferences"

log(){ printf "[snapshot-prefs] %s\n" "$*"; }

# Ensure the local prefs dir is a git repo pointing at mrk-prefs
if [[ ! -d "$LOCAL_PREFS_DIR/.git" ]]; then
  if [[ -d "$LOCAL_PREFS_DIR" ]]; then
    log "Initialising git repo in existing directory: $LOCAL_PREFS_DIR"
    git -C "$LOCAL_PREFS_DIR" init
    git -C "$LOCAL_PREFS_DIR" remote add origin "$PREFS_REPO"
  else
    log "Cloning $PREFS_REPO → $LOCAL_PREFS_DIR"
    git clone "$PREFS_REPO" "$LOCAL_PREFS_DIR"
  fi
fi

snapshot_plist(){
  local bundle_id="$1" filename="$2" app_path="$3" name="$4"
  if [[ ! -d "$app_path" ]]; then
    log "Skipping $name (not installed)"
    return 0
  fi
  defaults export "$bundle_id" "$LOCAL_PREFS_DIR/$filename" || {
    log "Warning: failed to export $name"
    return 1
  }
  log "Saved $name → $LOCAL_PREFS_DIR/$filename"
}

snapshot_plist "com.hegenberg.BetterSnapTool" "BetterSnapTool.plist" \
  "/Applications/BetterSnapTool.app" "BetterSnapTool"

snapshot_plist "com.jordanbaird.Ice"          "Ice.plist" \
  "/Applications/Ice.app" "Ice"

snapshot_plist "com.googlecode.iterm2"        "iTerm2.plist" \
  "/Applications/iTerm.app" "iTerm2"

# Commit and push if anything changed
cd "$LOCAL_PREFS_DIR"
git add .
if git diff --cached --quiet; then
  log "No changes to push."
else
  git commit -m "snapshot: $(date '+%Y-%m-%d %H:%M')"
  git push
  log "Pushed to $PREFS_REPO"
fi
